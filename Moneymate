package com.example.moneymate;

import android.animation.ObjectAnimator;
import android.app.DatePickerDialog;
import android.content.ClipData;
import android.content.ClipboardManager;
import android.content.Context;
import android.content.SharedPreferences;
import android.graphics.Color;
import android.graphics.Typeface;
import android.graphics.drawable.GradientDrawable;
import android.os.Bundle;
import android.text.InputType;
import android.view.Gravity;
import android.view.MenuItem;
import android.view.View;
import android.view.ViewGroup;
import android.view.animation.DecelerateInterpolator;
import android.widget.*;
import androidx.appcompat.app.AlertDialog;
import androidx.appcompat.app.AppCompatActivity;
import androidx.cardview.widget.CardView;
import androidx.core.content.ContextCompat;
import androidx.recyclerview.widget.LinearLayoutManager;
import androidx.recyclerview.widget.RecyclerView;
import com.google.android.material.floatingactionbutton.FloatingActionButton;
import java.text.SimpleDateFormat;
import java.util.*;

public class MainActivity extends AppCompatActivity {

    private EditText etAmount, etDescription;
    private TextView tvDate;
    private Button btnAdd;
    private RecyclerView recyclerView;
    private ExpenseAdapter adapter;
    private List<Expense> expenseList;
    private Calendar selectedDate;
    private TextView tvTotal;
    private FloatingActionButton fab;
    private LinearLayout inputCardContainer;
    private CardView inputCard;
    private Spinner categorySpinner;
    private Button btnExport, btnClearAll, btnFilter;
    private String selectedCategory = "Other";
    private List<String> categories;
    private SharedPreferences prefs;

    // Use the rupee symbol
    private static final String RUPEE = "\u20B9";

    // Advanced color palette
    private static final String PRIMARY = "#3A86FF";
    private static final String PRIMARY_DARK = "#265D97";
    private static final String ACCENT = "#FFBE0B";
    private static final String ERROR = "#FF006E";
    private static final String CARD_BG = "#FFFFFF";
    private static final String CARD_BORDER = "#E0E1E6";
    private static final String BACKGROUND_TOP = "#F5F6FA";
    private static final String BACKGROUND_BOTTOM = "#E9EBF0";
    private static final String TEXT_PRIMARY = "#22223B";
    private static final String TEXT_SECONDARY = "#6C6F7D";
    private static final String AMOUNT_COLOR = "#43AA8B";
    private static final String DATE_COLOR = "#3A86FF";

    private static final String PREFS_NAME = "moneymate_prefs";
    private static final String EXPENSES_KEY = "expenses_json";

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);

        // Set up a sophisticated, advanced gradient background (blue to light)
        FrameLayout root = new FrameLayout(this);
        GradientDrawable gradient = new GradientDrawable(
                GradientDrawable.Orientation.TL_BR,
                new int[] {
                        Color.parseColor(PRIMARY),
                        Color.parseColor(BACKGROUND_TOP),
                        Color.parseColor(BACKGROUND_BOTTOM)
                }
        );
        gradient.setCornerRadius(0f);
        root.setBackground(gradient);

        ScrollView scrollView = new ScrollView(this);
        scrollView.setFillViewport(true);

        LinearLayout mainLayout = new LinearLayout(this);
        mainLayout.setOrientation(LinearLayout.VERTICAL);
        mainLayout.setPadding(0, 0, 0, 0);

        // AppBar with logo and title
        LinearLayout appBar = new LinearLayout(this);
        appBar.setOrientation(LinearLayout.HORIZONTAL);
        appBar.setGravity(Gravity.CENTER_VERTICAL);
        appBar.setPadding(32, 80, 32, 32);

        ImageView logo = new ImageView(this);
        logo.setImageResource(android.R.drawable.ic_dialog_info);
        logo.setColorFilter(Color.parseColor(ACCENT));
        LinearLayout.LayoutParams logoParams = new LinearLayout.LayoutParams(110, 110);
        logoParams.setMargins(0, 0, 32, 0);
        appBar.addView(logo, logoParams);

        TextView title = new TextView(this);
        title.setText("MoneyMate");
        title.setTextSize(32);
        title.setTypeface(Typeface.create("sans-serif-medium", Typeface.BOLD));
        title.setTextColor(Color.parseColor(PRIMARY_DARK));
        appBar.addView(title);

        mainLayout.addView(appBar);

        // Subtitle
        TextView subtitle = new TextView(this);
        subtitle.setText("Your advanced expense companion");
        subtitle.setTextSize(18);
        subtitle.setTypeface(Typeface.create("sans-serif", Typeface.ITALIC));
        subtitle.setTextColor(Color.parseColor(TEXT_SECONDARY));
        subtitle.setPadding(32, 0, 32, 32);
        subtitle.setTextAlignment(View.TEXT_ALIGNMENT_CENTER);
        mainLayout.addView(subtitle);

        // Input Card Container (for animation)
        inputCardContainer = new LinearLayout(this);
        inputCardContainer.setOrientation(LinearLayout.VERTICAL);
        inputCardContainer.setGravity(Gravity.CENTER_HORIZONTAL);

        // Card for input
        inputCard = new CardView(this);
        inputCard.setCardBackgroundColor(Color.parseColor(CARD_BG));
        inputCard.setRadius(36);
        inputCard.setCardElevation(14);
        inputCard.setUseCompatPadding(true);

        // Add a colored border to input card
        GradientDrawable inputCardBg = new GradientDrawable();
        inputCardBg.setColor(Color.parseColor(CARD_BG));
        inputCardBg.setCornerRadius(36);
        inputCardBg.setStroke(4, Color.parseColor(PRIMARY));
        inputCard.setBackground(inputCardBg);

        LinearLayout inputLayout = new LinearLayout(this);
        inputLayout.setOrientation(LinearLayout.VERTICAL);
        inputLayout.setPadding(48, 48, 48, 48);

        // Amount Row
        LinearLayout amountRow = new LinearLayout(this);
        amountRow.setOrientation(LinearLayout.HORIZONTAL);
        amountRow.setGravity(Gravity.CENTER_VERTICAL);

        ImageView amountIcon = new ImageView(this);
        amountIcon.setImageResource(android.R.drawable.ic_menu_info_details);
        amountIcon.setColorFilter(Color.parseColor(AMOUNT_COLOR));
        LinearLayout.LayoutParams iconParams = new LinearLayout.LayoutParams(60, 60);
        iconParams.setMargins(0, 0, 20, 0);
        amountRow.addView(amountIcon, iconParams);

        etAmount = new EditText(this);
        etAmount.setHint("Amount (" + RUPEE + ")");
        etAmount.setInputType(InputType.TYPE_CLASS_NUMBER | InputType.TYPE_NUMBER_FLAG_DECIMAL);
        etAmount.setBackgroundResource(android.R.drawable.edit_text);
        etAmount.setPadding(24, 20, 24, 20);
        etAmount.setTextSize(18);
        etAmount.setTextColor(Color.parseColor(AMOUNT_COLOR));
        etAmount.setTypeface(Typeface.DEFAULT_BOLD);
        etAmount.setLayoutParams(new LinearLayout.LayoutParams(
                0, LinearLayout.LayoutParams.WRAP_CONTENT, 1f
        ));
        amountRow.addView(etAmount);

        inputLayout.addView(amountRow);

        // Description Row
        LinearLayout descRow = new LinearLayout(this);
        descRow.setOrientation(LinearLayout.HORIZONTAL);
        descRow.setGravity(Gravity.CENTER_VERTICAL);
        descRow.setPadding(0, 20, 0, 0);

        ImageView descIcon = new ImageView(this);
        descIcon.setImageResource(android.R.drawable.ic_menu_edit);
        descIcon.setColorFilter(Color.parseColor(PRIMARY_DARK));
        descRow.addView(descIcon, iconParams);

        etDescription = new EditText(this);
        etDescription.setHint("Description");
        etDescription.setBackgroundResource(android.R.drawable.edit_text);
        etDescription.setPadding(24, 20, 24, 20);
        etDescription.setTextSize(18);
        etDescription.setTextColor(Color.parseColor(TEXT_PRIMARY));
        etDescription.setLayoutParams(new LinearLayout.LayoutParams(
                0, LinearLayout.LayoutParams.WRAP_CONTENT, 1f
        ));
        descRow.addView(etDescription);

        inputLayout.addView(descRow);

        // Category Row (NEW FEATURE)
        LinearLayout categoryRow = new LinearLayout(this);
        categoryRow.setOrientation(LinearLayout.HORIZONTAL);
        categoryRow.setGravity(Gravity.CENTER_VERTICAL);
        categoryRow.setPadding(0, 20, 0, 0);

        ImageView catIcon = new ImageView(this);
        catIcon.setImageResource(android.R.drawable.ic_menu_sort_by_size);
        catIcon.setColorFilter(Color.parseColor(PRIMARY));
        categoryRow.addView(catIcon, iconParams);

        categories = Arrays.asList("Food", "Transport", "Shopping", "Bills", "Health", "Entertainment", "Other");
        categorySpinner = new Spinner(this);
        ArrayAdapter<String> catAdapter = new ArrayAdapter<>(this, android.R.layout.simple_spinner_dropdown_item, categories);
        categorySpinner.setAdapter(catAdapter);
        categorySpinner.setLayoutParams(new LinearLayout.LayoutParams(
                0, LinearLayout.LayoutParams.WRAP_CONTENT, 1f
        ));
        categorySpinner.setSelection(categories.size() - 1);
        categorySpinner.setOnItemSelectedListener(new AdapterView.OnItemSelectedListener() {
            @Override public void onItemSelected(AdapterView<?> parent, View view, int position, long id) {
                selectedCategory = categories.get(position);
            }
            @Override public void onNothingSelected(AdapterView<?> parent) {}
        });
        categoryRow.addView(categorySpinner);

        inputLayout.addView(categoryRow);

        // Date Row
        LinearLayout dateRow = new LinearLayout(this);
        dateRow.setOrientation(LinearLayout.HORIZONTAL);
        dateRow.setGravity(Gravity.CENTER_VERTICAL);
        dateRow.setPadding(0, 20, 0, 0);

        ImageView dateIcon = new ImageView(this);
        dateIcon.setImageResource(android.R.drawable.ic_menu_my_calendar);
        dateIcon.setColorFilter(Color.parseColor(DATE_COLOR));
        dateRow.addView(dateIcon, iconParams);

        tvDate = new TextView(this);
        tvDate.setText("Select Date");
        tvDate.setTextColor(Color.parseColor(DATE_COLOR));
        tvDate.setTextSize(18);
        tvDate.setPadding(24, 20, 24, 20);
        tvDate.setBackgroundResource(android.R.drawable.edit_text);
        tvDate.setGravity(Gravity.CENTER_VERTICAL);
        tvDate.setOnClickListener(v -> showDatePicker());
        tvDate.setLayoutParams(new LinearLayout.LayoutParams(
                0, LinearLayout.LayoutParams.WRAP_CONTENT, 1f
        ));
        dateRow.addView(tvDate);

        inputLayout.addView(dateRow);

        // Add Button
        btnAdd = new Button(this);
        btnAdd.setText("Add Expense");
        btnAdd.setBackgroundColor(Color.parseColor(PRIMARY));
        btnAdd.setTextColor(Color.WHITE);
        btnAdd.setTextSize(18);
        btnAdd.setTypeface(Typeface.DEFAULT_BOLD);
        btnAdd.setPadding(0, 28, 0, 28);
        btnAdd.setAllCaps(false);
        LinearLayout.LayoutParams btnParams = new LinearLayout.LayoutParams(
                LinearLayout.LayoutParams.MATCH_PARENT,
                LinearLayout.LayoutParams.WRAP_CONTENT
        );
        btnParams.setMargins(0, 36, 0, 0);
        inputLayout.addView(btnAdd, btnParams);

        // Export Button (NEW FEATURE)
        btnExport = new Button(this);
        btnExport.setText("Export Expenses");
        btnExport.setBackgroundColor(Color.parseColor(ACCENT));
        btnExport.setTextColor(Color.parseColor(PRIMARY_DARK));
        btnExport.setTextSize(15);
        btnExport.setAllCaps(false);
        btnExport.setPadding(0, 18, 0, 18);
        LinearLayout.LayoutParams exportParams = new LinearLayout.LayoutParams(
                LinearLayout.LayoutParams.MATCH_PARENT,
                LinearLayout.LayoutParams.WRAP_CONTENT
        );
        exportParams.setMargins(0, 18, 0, 0);
        inputLayout.addView(btnExport, exportParams);

        // Clear All Button (NEW FEATURE)
        btnClearAll = new Button(this);
        btnClearAll.setText("Clear All");
        btnClearAll.setBackgroundColor(Color.parseColor(ERROR));
        btnClearAll.setTextColor(Color.WHITE);
        btnClearAll.setTextSize(15);
        btnClearAll.setAllCaps(false);
        btnClearAll.setPadding(0, 18, 0, 18);
        LinearLayout.LayoutParams clearParams = new LinearLayout.LayoutParams(
                LinearLayout.LayoutParams.MATCH_PARENT,
                LinearLayout.LayoutParams.WRAP_CONTENT
        );
        clearParams.setMargins(0, 12, 0, 0);
        inputLayout.addView(btnClearAll, clearParams);

        // Filter Button (NEW FEATURE)
        btnFilter = new Button(this);
        btnFilter.setText("Filter");
        btnFilter.setBackgroundColor(Color.parseColor(PRIMARY_DARK));
        btnFilter.setTextColor(Color.WHITE);
        btnFilter.setTextSize(15);
        btnFilter.setAllCaps(false);
        btnFilter.setPadding(0, 18, 0, 18);
        LinearLayout.LayoutParams filterParams = new LinearLayout.LayoutParams(
                LinearLayout.LayoutParams.MATCH_PARENT,
                LinearLayout.LayoutParams.WRAP_CONTENT
        );
        filterParams.setMargins(0, 12, 0, 0);
        inputLayout.addView(btnFilter, filterParams);

        inputCard.addView(inputLayout);
        LinearLayout.LayoutParams cardParams = new LinearLayout.LayoutParams(
                LinearLayout.LayoutParams.MATCH_PARENT,
                LinearLayout.LayoutParams.WRAP_CONTENT
        );
        cardParams.setMargins(32, 0, 32, 32);
        inputCardContainer.addView(inputCard, cardParams);

        mainLayout.addView(inputCardContainer);

        // Total Card
        CardView totalCard = new CardView(this);
        totalCard.setCardBackgroundColor(Color.parseColor(ACCENT));
        totalCard.setRadius(28);
        totalCard.setCardElevation(8);
        LinearLayout.LayoutParams totalCardParams = new LinearLayout.LayoutParams(
                LinearLayout.LayoutParams.MATCH_PARENT,
                LinearLayout.LayoutParams.WRAP_CONTENT
        );
        totalCardParams.setMargins(32, 0, 32, 24);

        LinearLayout totalLayout = new LinearLayout(this);
        totalLayout.setOrientation(LinearLayout.HORIZONTAL);
        totalLayout.setGravity(Gravity.CENTER_VERTICAL);
        totalLayout.setPadding(36, 28, 36, 28);

        ImageView totalIcon = new ImageView(this);
        totalIcon.setImageResource(android.R.drawable.ic_menu_agenda);
        totalIcon.setColorFilter(Color.parseColor(PRIMARY_DARK));
        LinearLayout.LayoutParams totalIconParams = new LinearLayout.LayoutParams(54, 54);
        totalIconParams.setMargins(0, 0, 24, 0);
        totalLayout.addView(totalIcon, totalIconParams);

        tvTotal = new TextView(this);
        tvTotal.setText("Total: " + RUPEE + "0.00");
        tvTotal.setTextSize(24);
        tvTotal.setTypeface(Typeface.create("sans-serif-medium", Typeface.BOLD));
        tvTotal.setTextColor(Color.parseColor(PRIMARY_DARK));
        tvTotal.setGravity(Gravity.CENTER_VERTICAL);
        totalLayout.addView(tvTotal);

        totalCard.addView(totalLayout);
        mainLayout.addView(totalCard, totalCardParams);

        // RecyclerView for expenses
        recyclerView = new RecyclerView(this);
        recyclerView.setLayoutManager(new LinearLayoutManager(this));
        recyclerView.setPadding(0, 0, 0, 140);
        mainLayout.addView(recyclerView, new LinearLayout.LayoutParams(
                LinearLayout.LayoutParams.MATCH_PARENT,
                0, 1f
        ));

        scrollView.addView(mainLayout);
        root.addView(scrollView);

        // Floating Action Button for quick add
        fab = new FloatingActionButton(this);
        fab.setImageResource(android.R.drawable.ic_input_add);
        fab.setBackgroundTintList(ContextCompat.getColorStateList(this, android.R.color.holo_blue_dark));
        fab.setColorFilter(Color.parseColor(ACCENT));
        FrameLayout.LayoutParams fabParams = new FrameLayout.LayoutParams(
                130, 130, Gravity.BOTTOM | Gravity.END
        );
        fabParams.setMargins(0, 0, 56, 56);
        root.addView(fab, fabParams);

        setContentView(root);

        // Data
        prefs = getSharedPreferences(PREFS_NAME, MODE_PRIVATE);
        expenseList = new ArrayList<>();
        loadExpenses();
        adapter = new ExpenseAdapter(expenseList);
        recyclerView.setAdapter(adapter);

        selectedDate = Calendar.getInstance();

        btnAdd.setOnClickListener(v -> addExpense());
        fab.setOnClickListener(v -> showInputCard());
        btnExport.setOnClickListener(v -> exportExpenses());
        btnClearAll.setOnClickListener(v -> clearAllExpenses());
        btnFilter.setOnClickListener(v -> showFilterDialog());

        // Animate input card in
        inputCard.setAlpha(0f);
        inputCard.setVisibility(View.VISIBLE);
        inputCard.post(() -> {
            ObjectAnimator fadeIn = ObjectAnimator.ofFloat(inputCard, "alpha", 0f, 1f);
            fadeIn.setDuration(400);
            fadeIn.setInterpolator(new DecelerateInterpolator());
            fadeIn.start();
        });
    }

    private void showDatePicker() {
        Calendar now = Calendar.getInstance();
        DatePickerDialog dialog = new DatePickerDialog(this,
                (view, year, month, dayOfMonth) -> {
                    selectedDate.set(year, month, dayOfMonth);
                    tvDate.setText(String.format(Locale.getDefault(), "%02d/%02d/%04d", dayOfMonth, month + 1, year));
                },
                selectedDate.get(Calendar.YEAR),
                selectedDate.get(Calendar.MONTH),
                selectedDate.get(Calendar.DAY_OF_MONTH));
        dialog.getDatePicker().setMaxDate(System.currentTimeMillis());
        dialog.show();
    }

    private void showInputCard() {
        if (inputCard.getVisibility() == View.VISIBLE) {
            // Animate out
            ObjectAnimator fadeOut = ObjectAnimator.ofFloat(inputCard, "alpha", 1f, 0f);
            fadeOut.setDuration(300);
            fadeOut.setInterpolator(new DecelerateInterpolator());
            fadeOut.addListener(new android.animation.AnimatorListenerAdapter() {
                @Override
                public void onAnimationEnd(android.animation.Animator animation) {
                    inputCard.setVisibility(View.GONE);
                }
            });
            fadeOut.start();
        } else {
            inputCard.setVisibility(View.VISIBLE);
            ObjectAnimator fadeIn = ObjectAnimator.ofFloat(inputCard, "alpha", 0f, 1f);
            fadeIn.setDuration(300);
            fadeIn.setInterpolator(new DecelerateInterpolator());
            fadeIn.start();
        }
    }

    private void addExpense() {
        String amountStr = etAmount.getText().toString().trim();
        String desc = etDescription.getText().toString().trim();
        String cat = selectedCategory;
        if (amountStr.isEmpty() || desc.isEmpty() || tvDate.getText().toString().equals("Select Date") || cat.isEmpty()) {
            Toast toast = Toast.makeText(this, "Please fill all fields", Toast.LENGTH_SHORT);
            View view = toast.getView();
            if (view != null) view.setBackgroundColor(Color.parseColor(ERROR));
            toast.show();
            return;
        }
        double amount;
        try {
            amount = Double.parseDouble(amountStr);
        } catch (NumberFormatException e) {
            Toast toast = Toast.makeText(this, "Invalid amount", Toast.LENGTH_SHORT);
            View view = toast.getView();
            if (view != null) view.setBackgroundColor(Color.parseColor(ERROR));
            toast.show();
            return;
        }
        if (amount <= 0) {
            Toast toast = Toast.makeText(this, "Amount must be greater than zero", Toast.LENGTH_SHORT);
            View view = toast.getView();
            if (view != null) view.setBackgroundColor(Color.parseColor(ERROR));
            toast.show();
            return;
        }
        // Defensive copy of date
        Expense expense = new Expense(amount, desc, (Date) selectedDate.getTime().clone(), cat);
        expenseList.add(0, expense);
        saveExpenses();
        adapter.notifyItemInserted(0);
        recyclerView.scrollToPosition(0);
        updateTotal();
        etAmount.setText("");
        etDescription.setText("");
        tvDate.setText("Select Date");
        categorySpinner.setSelection(categories.size() - 1);
        // Reset selectedDate to today for next entry
        selectedDate = Calendar.getInstance();

        // Animate card out after adding
        if (inputCard.getVisibility() == View.VISIBLE) {
            showInputCard();
        }
    }

    private void updateTotal() {
        double total = 0;
        for (Expense e : expenseList) {
            total += e.amount;
        }
        tvTotal.setText(String.format(Locale.getDefault(), "Total: %s%.2f", RUPEE, total));
    }

    // Export expenses to clipboard as CSV (NEW FEATURE)
    private void exportExpenses() {
        if (expenseList.isEmpty()) {
            Toast.makeText(this, "No expenses to export", Toast.LENGTH_SHORT).show();
            return;
        }
        StringBuilder sb = new StringBuilder();
        sb.append("Amount,Description,Category,Date\n");
        SimpleDateFormat sdf = new SimpleDateFormat("dd/MM/yyyy", Locale.getDefault());
        for (Expense e : expenseList) {
            sb.append(String.format(Locale.getDefault(), "%.2f,\"%s\",\"%s\",%s\n",
                    e.amount, e.description.replace("\"", "\"\""), e.category, sdf.format(e.date)));
        }
        ClipboardManager clipboard = (ClipboardManager) getSystemService(Context.CLIPBOARD_SERVICE);
        ClipData clip = ClipData.newPlainText("Expenses", sb.toString());
        clipboard.setPrimaryClip(clip);
        Toast.makeText(this, "Expenses copied to clipboard as CSV", Toast.LENGTH_SHORT).show();
    }

    // Clear all expenses (NEW FEATURE)
    private void clearAllExpenses() {
        if (expenseList.isEmpty()) {
            Toast.makeText(this, "No expenses to clear", Toast.LENGTH_SHORT).show();
            return;
        }
        new AlertDialog.Builder(this)
                .setTitle("Clear All Expenses")
                .setMessage("Are you sure you want to delete all expenses?")
                .setPositiveButton("Yes", (dialog, which) -> {
                    expenseList.clear();
                    saveExpenses();
                    adapter.notifyDataSetChanged();
                    updateTotal();
                })
                .setNegativeButton("No", null)
                .show();
    }

    // Filter expenses by category or date (NEW FEATURE)
    private void showFilterDialog() {
        final String[] filterOptions = {"All", "By Category", "By Date"};
        new AlertDialog.Builder(this)
                .setTitle("Filter Expenses")
                .setItems(filterOptions, (dialog, which) -> {
                    if (which == 0) {
                        // All
                        loadExpenses();
                        adapter.setExpenses(expenseList);
                        adapter.notifyDataSetChanged();
                        updateTotal();
                    } else if (which == 1) {
                        // By Category
                        showCategoryFilterDialog();
                    } else if (which == 2) {
                        // By Date
                        showDateFilterDialog();
                    }
                })
                .show();
    }

    private void showCategoryFilterDialog() {
        final String[] cats = categories.toArray(new String[0]);
        new AlertDialog.Builder(this)
                .setTitle("Select Category")
                .setItems(cats, (dialog, which) -> {
                    String cat = cats[which];
                    List<Expense> filtered = new ArrayList<>();
                    for (Expense e : expenseList) {
                        if (e.category.equals(cat)) filtered.add(e);
                    }
                    adapter.setExpenses(filtered);
                    adapter.notifyDataSetChanged();
                    updateTotalFiltered(filtered);
                })
                .show();
    }

    private void showDateFilterDialog() {
        final Calendar cal = Calendar.getInstance();
        DatePickerDialog dialog = new DatePickerDialog(this,
                (view, year, month, dayOfMonth) -> {
                    cal.set(year, month, dayOfMonth);
                    List<Expense> filtered = new ArrayList<>();
                    for (Expense e : expenseList) {
                        Calendar eCal = Calendar.getInstance();
                        eCal.setTime(e.date);
                        if (eCal.get(Calendar.YEAR) == cal.get(Calendar.YEAR) &&
                                eCal.get(Calendar.MONTH) == cal.get(Calendar.MONTH) &&
                                eCal.get(Calendar.DAY_OF_MONTH) == cal.get(Calendar.DAY_OF_MONTH)) {
                            filtered.add(e);
                        }
                    }
                    adapter.setExpenses(filtered);
                    adapter.notifyDataSetChanged();
                    updateTotalFiltered(filtered);
                },
                cal.get(Calendar.YEAR),
                cal.get(Calendar.MONTH),
                cal.get(Calendar.DAY_OF_MONTH));
        dialog.getDatePicker().setMaxDate(System.currentTimeMillis());
        dialog.show();
    }

    private void updateTotalFiltered(List<Expense> filtered) {
        double total = 0;
        for (Expense e : filtered) {
            total += e.amount;
        }
        tvTotal.setText(String.format(Locale.getDefault(), "Total: %s%.2f", RUPEE, total));
    }

    // Save/load expenses to SharedPreferences (NEW FEATURE)
    private void saveExpenses() {
        try {
            StringBuilder sb = new StringBuilder();
            SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd", Locale.getDefault());
            for (Expense e : expenseList) {
                sb.append(e.amount).append("||")
                        .append(e.description.replace("|", " ")).append("||")
                        .append(e.category.replace("|", " ")).append("||")
                        .append(sdf.format(e.date)).append("||");
            }
            prefs.edit().putString(EXPENSES_KEY, sb.toString()).apply();
        } catch (Exception ignored) {}
    }

    private void loadExpenses() {
        expenseList = new ArrayList<>();
        String data = prefs.getString(EXPENSES_KEY, "");
        if (data == null || data.isEmpty()) return;
        String[] parts = data.split("\\|\\|");
        SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd", Locale.getDefault());
        for (int i = 0; i + 3 < parts.length; i += 4) {
            try {
                double amount = Double.parseDouble(parts[i]);
                String desc = parts[i + 1];
                String cat = parts[i + 2];
                Date date = sdf.parse(parts[i + 3]);
                expenseList.add(new Expense(amount, desc, date, cat));
            } catch (Exception ignored) {}
        }
    }

    // Expense model
    static class Expense {
        double amount;
        String description;
        Date date;
        String category;

        Expense(double amount, String description, Date date, String category) {
            this.amount = amount;
            this.description = description;
            this.date = date;
            this.category = category;
        }
    }

    // RecyclerView Adapter
    class ExpenseAdapter extends RecyclerView.Adapter<ExpenseAdapter.ExpenseViewHolder> {
        private List<Expense> expenses;
        // Use a colorful accent for all cards for a sophisticated look
        private final int cardColor = Color.parseColor(CARD_BG);
        private final int borderColor = Color.parseColor(PRIMARY);

        ExpenseAdapter(List<Expense> expenses) {
            this.expenses = expenses;
        }

        public void setExpenses(List<Expense> newList) {
            this.expenses = newList;
        }

        @Override
        public ExpenseViewHolder onCreateViewHolder(ViewGroup parent, int viewType) {
            CardView card = new CardView(parent.getContext());
            card.setRadius(24);
            card.setCardElevation(8);
            card.setUseCompatPadding(true);
            card.setCardBackgroundColor(cardColor);

            // Add a border to the card for separation
            card.setPreventCornerOverlap(false);
            card.setContentPadding(0, 0, 0, 0);

            LinearLayout layout = new LinearLayout(parent.getContext());
            layout.setOrientation(LinearLayout.VERTICAL);
            layout.setPadding(40, 32, 40, 32);

            // Description
            TextView tvDesc = new TextView(parent.getContext());
            tvDesc.setTextSize(19);
            tvDesc.setTypeface(Typeface.create("sans-serif-medium", Typeface.BOLD));
            tvDesc.setTextColor(Color.parseColor(TEXT_PRIMARY));
            layout.addView(tvDesc);

            // Category (NEW FEATURE)
            TextView tvCat = new TextView(parent.getContext());
            tvCat.setTextSize(15);
            tvCat.setTypeface(Typeface.DEFAULT_BOLD);
            tvCat.setTextColor(Color.parseColor(PRIMARY));
            tvCat.setPadding(0, 6, 0, 0);
            layout.addView(tvCat);

            // Amount and Date Row
            LinearLayout row = new LinearLayout(parent.getContext());
            row.setOrientation(LinearLayout.HORIZONTAL);
            row.setGravity(Gravity.CENTER_VERTICAL);
            row.setPadding(0, 18, 0, 0);

            TextView tvAmount = new TextView(parent.getContext());
            tvAmount.setTextSize(17);
            tvAmount.setTypeface(Typeface.DEFAULT_BOLD);
            tvAmount.setTextColor(Color.parseColor(AMOUNT_COLOR));
            row.addView(tvAmount);

            Space space = new Space(parent.getContext());
            LinearLayout.LayoutParams spaceParams = new LinearLayout.LayoutParams(0, 1, 1f);
            row.addView(space, spaceParams);

            TextView tvDate = new TextView(parent.getContext());
            tvDate.setTextSize(15);
            tvDate.setTextColor(Color.parseColor(DATE_COLOR));
            row.addView(tvDate);

            layout.addView(row);

            // Delete Button
            Button btnDelete = new Button(parent.getContext());
            btnDelete.setText("Delete");
            btnDelete.setTextColor(Color.WHITE);
            btnDelete.setBackgroundColor(Color.parseColor(ERROR));
            btnDelete.setAllCaps(false);
            btnDelete.setTextSize(15);
            btnDelete.setTypeface(Typeface.DEFAULT_BOLD);
            btnDelete.setPadding(0, 16, 0, 16);
            LinearLayout.LayoutParams delParams = new LinearLayout.LayoutParams(
                    LinearLayout.LayoutParams.WRAP_CONTENT,
                    LinearLayout.LayoutParams.WRAP_CONTENT
            );
            delParams.gravity = Gravity.END;
            delParams.setMargins(0, 24, 0, 0);
            layout.addView(btnDelete, delParams);

            card.addView(layout);

            // Set layout params for card
            RecyclerView.LayoutParams params = new RecyclerView.LayoutParams(
                    ViewGroup.LayoutParams.MATCH_PARENT,
                    ViewGroup.LayoutParams.WRAP_CONTENT
            );
            params.setMargins(32, 14, 32, 14);
            card.setLayoutParams(params);

            // Add a colorful border using a background drawable
            card.setBackground(new GradientDrawable() {{
                setColor(cardColor);
                setCornerRadius(24);
                setStroke(4, borderColor);
            }});

            return new ExpenseViewHolder(card, tvDesc, tvAmount, tvDate, btnDelete, tvCat);
        }

        @Override
        public void onBindViewHolder(ExpenseViewHolder holder, int position) {
            Expense expense = expenses.get(position);
            holder.tvDesc.setText(expense.description);
            holder.tvAmount.setText(String.format(Locale.getDefault(), "%s%.2f", RUPEE, expense.amount));
            Calendar cal = Calendar.getInstance();
            cal.setTime(expense.date);
            holder.tvDate.setText(String.format(Locale.getDefault(), "%02d/%02d/%04d",
                    cal.get(Calendar.DAY_OF_MONTH),
                    cal.get(Calendar.MONTH) + 1,
                    cal.get(Calendar.YEAR)));
            holder.tvCat.setText("Category: " + expense.category);

            holder.btnDelete.setOnClickListener(v -> {
                int pos = holder.getAdapterPosition();
                if (pos != RecyclerView.NO_POSITION) {
                    expenses.remove(pos);
                    saveExpenses();
                    notifyItemRemoved(pos);
                    updateTotal();
                }
            });

            // Long press to copy details (NEW FEATURE)
            holder.card.setOnLongClickListener(v -> {
                String details = String.format(Locale.getDefault(),
                        "%s%.2f | %s | %s | %02d/%02d/%04d",
                        RUPEE, expense.amount, expense.description, expense.category,
                        cal.get(Calendar.DAY_OF_MONTH), cal.get(Calendar.MONTH) + 1, cal.get(Calendar.YEAR));
                ClipboardManager clipboard = (ClipboardManager) getSystemService(Context.CLIPBOARD_SERVICE);
                ClipData clip = ClipData.newPlainText("Expense", details);
                clipboard.setPrimaryClip(clip);
                Toast.makeText(MainActivity.this, "Expense copied to clipboard", Toast.LENGTH_SHORT).show();
                return true;
            });

            // Animate card in
            holder.card.setAlpha(0f);
            holder.card.post(() -> {
                ObjectAnimator fadeIn = ObjectAnimator.ofFloat(holder.card, "alpha", 0f, 1f);
                fadeIn.setDuration(300);
                fadeIn.setInterpolator(new DecelerateInterpolator());
                fadeIn.start();
            });
        }

        @Override
        public int getItemCount() {
            return expenses.size();
        }

        class ExpenseViewHolder extends RecyclerView.ViewHolder {
            CardView card;
            TextView tvDesc, tvAmount, tvDate, tvCat;
            Button btnDelete;

            ExpenseViewHolder(View itemView, TextView tvDesc, TextView tvAmount, TextView tvDate, Button btnDelete, TextView tvCat) {
                super(itemView);
                this.card = (CardView) itemView;
                this.tvDesc = tvDesc;
                this.tvAmount = tvAmount;
                this.tvDate = tvDate;
                this.btnDelete = btnDelete;
                this.tvCat = tvCat;
            }
        }
    }
}
